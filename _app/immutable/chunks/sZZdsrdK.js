import{Z as U,b as I,ao as O,a8 as T,ab as f}from"./Dj1ftB3a.js";const j=[];function m(t,r=!1,n=!1){return p(t,new Map,"",j,null,n)}function p(t,r,n,s,o=null,c=!1){if(typeof t=="object"&&t!==null){var d=r.get(t);if(d!==void 0)return d;if(t instanceof Map)return new Map(t);if(t instanceof Set)return new Set(t);if(U(t)){var i=Array(t.length);r.set(t,i),o!==null&&r.set(o,i);for(var l=0;l<t.length;l+=1){var D=t[l];l in t&&(i[l]=p(D,r,n,s,null,c))}return i}if(I(t)===O){i={},r.set(t,i),o!==null&&r.set(o,i);for(var g of Object.keys(t))i[g]=p(t[g],r,n,s,null,c);return i}if(t instanceof Date)return structuredClone(t);if(typeof t.toJSON=="function"&&!c)return p(t.toJSON(),r,n,s,t)}if(t instanceof EventTarget)return t;try{return structuredClone(t)}catch{return t}}function b(t){return new Promise((r,n)=>{t.oncomplete=t.onsuccess=()=>r(t.result),t.onabort=t.onerror=()=>n(t.error)})}function C(t,r){let n;const s=()=>{if(n)return n;const o=indexedDB.open(t);return o.onupgradeneeded=()=>o.result.createObjectStore(r),n=b(o),n.then(c=>{c.onclose=()=>n=void 0},()=>{}),n};return(o,c)=>s().then(d=>c(d.transaction(r,o).objectStore(r)))}let S;function y(){return S||(S=C("keyval-store","keyval")),S}function u(t,r=y()){return r("readonly",n=>b(n.get(t)))}function a(t,r,n=y()){return n("readwrite",s=>(s.put(r,t),b(s.transaction)))}let J=t=>new Promise(r=>setTimeout(r,t)),e=T({triliumUrl:"",triliumSecret:"",topicsDb:null,notes:null,updatedNotes:null});(async()=>(e.triliumUrl=await u("triliumUrl")||"",e.triliumSecret=await u("triliumSecret")||"",e.topicsDb=await u("topicsDb")||null,e.notes=await u("notes")||null,e.updatedNotes=await u("updatedNotes")||{},setInterval(N,5e3)))();function E(){f(()=>{e.triliumUrl&&a("triliumUrl",e.triliumUrl)}),f(()=>{e.triliumSecret&&a("triliumSecret",e.triliumSecret)}),f(()=>{e.topicsDb&&a("topicsDb",m(e.topicsDb))}),f(()=>{e.notes&&a("notes",m(e.notes))}),f(()=>{e.updatedNotes&&a("updatedNotes",m(e.updatedNotes))}),f(()=>{e.triliumUrl,e.triliumSecret,w(),N()})}async function N(){if(!e.triliumUrl||!e.triliumSecret||!e.updatedNotes?.length)return;let t=[];for(let r in e.updatedNotes){console.log("found updated note",r);try{await fetch(e.triliumUrl+"/custom/set-note",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:e.triliumSecret,noteId:r,content:e.updatedNotes[r].content})}),console.log("Uploaded updated note: ",r),t.push(r)}catch(n){console.error("Error uploading updated note: ",n)}}for(let r of t)delete e.updatedNotes[r];t?.length>0&&(await J(1500),w())}let h=!1;async function w(){h||(h=!0,console.log("refreshing db"),!(!e.triliumUrl||!e.triliumSecret)&&(async()=>{try{const t=await fetch(e.triliumUrl+"/custom/get-topic-notes",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:e.triliumSecret})});e.topicsDb=await t.json(),M()}catch(t){console.error("Error fetching topicsDb: ",t)}finally{h=!1}})())}async function M(){if(e.topicsDb){e.notes==null&&(e.notes={});for(let t of e?.topicsDb?.children||[])for(let r of t.children)if(!e.notes[r.noteId]||e.notes[r.noteId].dateModified!=r.dateModified){console.log("updated note: ",r.noteId);try{let n=await fetch(e.triliumUrl+"/custom/get-note",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({secret:e.triliumSecret,noteId:r.noteId})});e.notes[r.noteId]=await n.json()}catch(n){console.error("Error fetching note: ",n)}}}}export{E as i,e as t};
